service: zani

provider:
  name: aws
  runtime: nodejs10.x
  stage: ${opt:stage, 'development'}
  region: ${opt:region, 'ap-northeast-2'}
  logRetentionInDays: 30
  versionFunctions: false
  timeout: 30
  memorySize: 128
  iamRoleStatements:
    - Effect: 'Allow'
      Action:
        - 'dynamodb:*'
      Resource:
        - 'Fn::Join':
            - ':'
            -
              - 'arn:aws:dynamodb'
              - Ref: 'AWS::Region'
              - Ref: 'AWS::AccountId'
              - 'table/claude.${self:provider.stage}.commits'
        - 'Fn::Join':
            - ':'
            - - 'arn:aws:dynamodb'
              - Ref: 'AWS::Region'
              - Ref: 'AWS::AccountId'
              - 'table/claude.${self:provider.stage}.repository'
  deploymentBucket:
    name: claude.serverless.${self:provider.region}.deploys
    serverSideEncryption: AES256
  environment:
    TZ: Asia/Seoul
    NODE_ENV: ${opt:stage, 'development'}
  tracing:
    lambda: true
    apiGateway: true

plugins:
  - serverless-webpack
  - serverless-offline

functions:
  webhook:
    handler: src/api/webhook/controller.exec
    description: 'github webhook'
    events:
      - http:
          path: /hooks
          method: post
          cors: false

  notifier:
    handler: src/task/notifier.exec
    description: 'send notification about commit'
    events:
      - schedule:
          rate: cron(30 13 * * ? *)
          description: '1차 안내 메시지 발송 (KST 22시 30분)'
          input:
            type: 'nudge'
      - schedule:
          rate: cron(50 14 * * ? *)
          description: '경고 메시지 발송 (KST 23시 50분)'
          input:
            type: 'warning'
      - schedule:
          rate: cron(10 15 * * ? *)
          description: '시간 초과 안내 메시지 발송 (KST 00시 10분)'
          input:
            type: 'detect'

custom:
  webpack:
    webpackConfig: ./webpack.config.js
    includeModules: false
    packager: 'npm'
